(function(e,t){if(typeof define==="function"&&define.amd){define(["backbone","underscore"],t)}else if(typeof exports==="object"){module.exports=t(require("backbone"),require("underscore"))}else{e.Assembler=t(e.Backbone,e._)}})(this,function(e,t){var i={};i.View=e.View.extend({template:null,modelEvents:null,collectionEvents:null,lazy:null,constructor:function(t){this.options=t||(t={});e.View.prototype.constructor.call(this,t)},initialize:function(e){t.extend(this,t.pick(e,"template","modelEvents","collectionEvents","lazy"));if(this.template){this.setTemplate(this.template)}if(this.model){this.delegateModelEvents()}if(this.collection){this.delegateCollectionEvents()}},_listenToEvents:function(e,i){t.each(i,function(i,n){if(!t.isFunction(i)){i=this[i]}if(!i){throw new Error('Method "'+i+'" does not exist')}this.listenTo(e,n,i)},this)},delegateModelEvents:function(){this.listenTo(this.model,"change",this.voidRendered);this._listenToEvents(this.model,t.result(this,"modelEvents"))},undelegateModelEvents:function(){this.stopListening(this.model)},delegateCollectionEvents:function(){this._listenToEvents(this.collection,t.result(this,"collectionEvents"))},undelegateCollectionEvents:function(){this.stopListening(this.collection)},setModel:function(e){if(this.model){this.undelegateModelEvents()}this.model=e;if(e){this.delegateModelEvents()}this.voidRendered();return this},setCollection:function(e){if(this.collection){this.undelegateCollectionEvents()}this.collection=e;if(e){this.delegateCollectionEvents()}this.voidRendered();return this},setTemplate:function(e){if(!t.isFunction(e)){e=t.template(e)}this.template=e;this.voidRendered();return this},ready:function(t){var i=[];if(this.model){i.push(this.model.fetch(t))}if(this.collection){i.push(this.collection.fetch(t))}return this.promiseCoupler(e.$.when.apply(e.$.when,i),t)},promiseCoupler:function(e,t){return e},swapModel:function(e){var t=this;return e.fetch().done(function(){t.setModel(e);t.render()})},swapCollection:function(e){var t=this;return e.fetch().done(function(){t.setCollection(e);t.render()})},toJSON:function(){var e=this.model?this.model.toJSON():{};return this.dataDecorator(e)},dataDecorator:function(e){return e},toHTML:function(){return this.template?this.template(this.toJSON()):""},render:function(e){return this.renderElement(e).renderState(e)},renderElement:function(e){e||(e={});if(e.force||!t.result(this,"lazy")||!this._rendered){this.$el.html(this.toHTML());this._rendered=true}return this},renderState:function(e){return this},attach:function(e){return this.attachElement(e).attachState()},attachElement:function(e){e||(e=this.$el);this._rendered=!!e.length;return this.setElement(e)},attachState:function(){return this},voidRendered:function(){this._rendered=false},remove:function(){if(this.parentView){this.parentView.removeView(this)}return e.View.prototype.remove.call(this)},innerHTML:function(){return this.$el.html()},outerHTML:function(){var e=t.keys(t.result(this,"attributes"));if(this.id){e.push("id")}if(this.className){e.push("class")}var i=t.result(this,"tagName");var n=t.reduce(e,function(e,t){var i;if(i=this.$el.attr(t)){return e+" "+t+'="'+i+'"'}return e},i,this);return"<"+n+">"+this.$el.html()+"</"+i+">"},clone:function(){return new this.constructor(this.options)}});i.LayoutView=function(){var n=i.View.extend({viewEvents:null,constructor:function(e){this.options=e||(e={});this.views=[];this._views=[];this._totals=new o;i.View.prototype.constructor.call(this,e)},initialize:function(e){i.View.prototype.initialize.call(this,e);t.extend(this,t.pick(e,"viewEvents"));if(e.views){this.resetViews(e.views)}},delegateViewEvents:function(e){this._listenToEvents(e,t.result(this,"viewEvents"))},undelegateViewEvents:function(e){this.stopListening(e)},addView:function(e,t){var i=e.match(s),n=i[1],r=i[2];var o={destination:e,view:t,method:n,selector:r,index:this._totals.increase(n,r)};this._add(o);return t},removeView:function(e){var t=this._find(e)[0];if(t){return this._remove(t)}},getView:function(e){var t=this._find(e)[0];if(t){return t.view}},resetViews:function(e){t.each(this._views,this._remove,this);t.each(e,function(e,t){this.addView(t,e)},this)},_find:function(e){var i=t.isString(e)?"destination":"view";return t.filter(this._views,function(t){return t[i]===e})},_add:function(e){this._views.push(e);this.views.push(e.view);e.view.parentView=this;this.delegateViewEvents(e.view)},_remove:function(e){if(t.indexOf(this._views,e)!=-1){this._totals.decrease(e.method,e.selector);t.each(this._views,function(t){if(t.index>e.index&&t.method===e.method&&t.selector===e.selector){t.index--}});this._views=t.without(this._views,e);this.views=t.without(this.views,e.view);if(e.view.parentView===this){delete e.view.parentView}this.undelegateViewEvents(e.view);e.view.remove()}},ready:function(n){var s=i.View.prototype.ready.call(this,n);var r=[];t.each(this.views,function(e){r.push(e.ready())},this);return s.then(function(){return e.$.when.apply(e.$.when,r)})},swapView:function(e,t){var i=this.getView(e);var n=this;return t.ready().done(function(){n.removeView(i);n.addView(e,t);n.renderViews()})},partial:function(e,t,i,n,s){$el=t?this.$el.find(t):this.$el;return r[e].call(this,$el,i,n,s)},render:function(e){return this.renderElement(e).renderViews(e).renderState(e)},renderViews:function(e){t.each(this._views,function(t){var i=this._totals.get(t.method,t.selector);this.partial(t.method,t.selector,t.index,i,t.view.render(e).$el);t.view.delegateEvents()},this);return this},attach:function(e){return this.attachElement(e).attachViews().attachState()},attachViews:function(){t.each(this._views,function(e){var t=this._totals.get(e.method,e.selector);var i=this.partial(e.method,e.selector,e.index,t);if(i[0]){e.view.attach(i)}},this);return this}});var s=/^(inner|outer|prepend|append|before|after)\s*(.*)$/i;var r={inner:function(e,t,i,n){if(n){return e.empty().append(n)}return e.children().first()},outer:function(e,t,i,n){if(n&&n[0]!==e[0]){return e.replaceWith(n)}return e},prepend:function(e,t,i,n){if(n){return e.prepend(n)}return e.children().eq(i-1-t)},append:function(e,t,i,n){if(n){return e.append(n)}return e.children().eq(t-i)},before:function(e,t,i,n){if(n){return e.before(n)}return e.prevAll().eq(i-1-t)},after:function(e,t,i,n){if(n){return e.after(n)}return e.nextAll().eq(i-1-t)}};function o(){this.counts={}}o.prototype.key=function(){var e=Array.prototype.slice.call(arguments);return e.join("/")};o.prototype.increase=function(){var e=this.key.apply(this,arguments);this.counts[e]||(this.counts[e]=0);return this.counts[e]++};o.prototype.decrease=function(){var e=this.key.apply(this,arguments);this.counts[e]||(this.counts[e]=0);return--this.counts[e]};o.prototype.get=function(){var e=this.key.apply(this,arguments);return this.counts[e]||0};return n}();i.ListView=i.LayoutView.extend({itemDestination:"append",itemView:i.View,initialize:function(e){t.extend(this,t.pick(e,"itemDestination","itemView"));if(!this.itemView){throw new Error("ListView.initialize expects this.itemView or options.itemView")}else if(!t.isFunction(this.itemView)){throw new Error("ListView.initialize expects this.itemView to be a constructor")}i.LayoutView.prototype.initialize.call(this,e);if(this.collection){this.resetItemViews(this.collection)}},delegateCollectionEvents:function(){this.listenTo(this.collection,"add",this.addItemView);this.listenTo(this.collection,"remove",this.removeItemView);this.listenTo(this.collection,"reset",this.resetItemViews);this.listenTo(this.collection,"sort",this.sortItemViews);i.LayoutView.prototype.delegateCollectionEvents.call(this)},setCollection:function(e){this.resetItemViews(e);return i.LayoutView.prototype.setCollection.call(this,e)},createItemView:function(e){return new this.itemView({model:e})},addItemView:function(e){return this.addView(this.itemDestination,this.createItemView(e))},removeItemView:function(e){return this.removeView(e)},getItemView:function(e){return this.getView(e)},resetItemViews:function(e){t.each(this._find(this.itemDestination),this._remove,this);e.each(this.addItemView,this)},sortItemViews:function(e){this.resetItemViews(e)},_find:function(n){if(n instanceof e.Model){return t.filter(this._views,function(e){return e.view.model===n})}return i.LayoutView.prototype._find.call(this,n)}});return i});
//# sourceMappingURL=dist/assembler-min.map